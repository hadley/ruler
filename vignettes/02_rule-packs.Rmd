---
title: "Rule packs"
author: "Evgeni Chasnovski"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Rule packs}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## Overview

__Rule__ is a function which converts data unit of interest (data, group,
column, row, cell) to logical value indicating whether this object satisfies
certain condition.

__Rule pack__ is a function which combines several rules into one functional
block.

The recommended way of creating rules is by creating packs right away with the use of `dplyr` and [magrittr](http://magrittr.tidyverse.org/)'s
pipe operator.

## Data rule packs

To check whether dimensions of `mtcars` obey some rules one can write the next
dplyr pipeline:

```{r Data dimensions of mtcars}
mtcars %>% summarise(
  nrow_low = nrow(.) > 10,
  nrow_high = nrow(.) < 30,
  ncol = ncol(.) == 12
)
```

There is a way to create a function to be used for any data `mtcars` should be
replaced with `.`. To indicate that this function is a pack of rules that check
the data it should be wrapped with `data_packs()`.

The next code creates a list `my_data_packs` with one element `my_data_pack_1`
(name can be omitted). That element is a data rule pack which defines a pack of
rules with names `nrow_low`, `nrow_high`, `ncol`.

```{r Data dimensions rule pack}
my_data_packs <- data_packs(
  my_data_pack_1 = . %>% summarise(
    nrow_low = nrow(.) > 10,
    nrow_high = nrow(.) < 30,
    ncol = ncol(.) == 12
  )
)
```

## Group rule packs

The next code creates a list with one nameless group rule pack (the name will be
imputed automatically after applying this pack). This pack contains one rule
`any_cyl_6` which checks every group defined by `vs` and `am` columns. __Note__
that names of grouping columns should be supplied with `.group_vars` argument.

```{r Group rule pack}
my_group_packs <- group_packs(
  . %>% group_by(vs, am) %>%
    summarise(any_cyl_6 = any(cyl == 6)),
  .group_vars = c("vs", "am")
)
```

## Column rule packs

The next code creates a list with two elements:

- A column rule pack `my_col_pack_1` which checks two 'sum' properties for only the columns with names starting with "c" (any other column is not checked). Rules have names `sum_low` and `sum_high`.
- A nameless column rule pack which creates some character column and then checks all columns whether they are numeric. Rule will have imputed name `rule..1`.

__Note__ the use of `rules()` inside of `dplyr`'s scoped verbs. `rules()` is basically the standard `funs()` function but with extra name imputing for implemented interpretation.

```{r Column rule pack}
my_col_packs <- col_packs(
  my_col_pack_1 = . %>% summarise_at(
    vars(starts_with("c")),
    rules(sum_low = sum(.) > 300, sum_high = sum(.) < 400)
  ),
  . %>% mutate(chrColumn = rep("a", n())) %>%
    summarise_all(
      rules(is.numeric)
    )
)
```

## Row rule pack

The next code creates a list with one row pack `my_row_pack_1`. It contains one rule `is_common_row_mean` that checks 6 rows (from 10 to 15) for not being an outlier (based on the all rows) in terms of row means.

__Note__ that after `slice()` extracted rows will be interpreted as rows 10-15 from original data. This is possible because packs will be applied to the version of input data frame which tracks row rearrangements. For more information check out the [keyholder](https://github.com/echasnovski/keyholder) package.

```{r Row rule pack}
z_score <- function(x) {(x - mean(x)) / sd(x)}

my_row_packs <- row_packs(
  my_row_pack_1 = . %>% mutate(rowMean = rowMeans(.)) %>%
    transmute(is_common_row_mean = abs(z_score(rowMean)) < 1) %>%
    slice(10:15)
)
```

## Cell rule pack

The next code creates a list with one cell pack `my_cell_pack_1`. It checks cell of every integer-like column in rows 20-30. The rule `is_common` checks the values for not being an outlier within column.

```{r Cell rule pack}
is_integerish <- function(x) {all(x == as.integer(x))}

my_cell_packs <- cell_packs(
  my_cell_pack_1 = . %>% transmute_if(
    is_integerish,
    rules(is_common = abs(z_score(.)) < 1)
  ) %>%
    slice(20:30)
)
```
